{"componentChunkName":"component---src-templates-blog-template-js","path":"/tech-talk-2020/2020-01-10-DOM-screenshot/","result":{"data":{"cur":{"id":"224ce30f-59e2-5f46-b58e-e4dbb12189f2","html":"<h3 id=\"소개\" style=\"position:relative;\"><a href=\"#%EC%86%8C%EA%B0%9C\" aria-label=\"소개 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>소개</h3>\n<ul>\n<li>svg, canvas, 일반 DOM이 섞여 있는 Web Page을 브라우저에서 screenshot을 생성하기 위한 web tech tip에 대해서 이야기 합니다.</li>\n</ul>\n<h3 id=\"web에서-스크린샷-생성하는-lib\" style=\"position:relative;\"><a href=\"#web%EC%97%90%EC%84%9C-%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7-%EC%83%9D%EC%84%B1%ED%95%98%EB%8A%94-lib\" aria-label=\"web에서 스크린샷 생성하는 lib permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Web에서 스크린샷 생성하는 Lib</h3>\n<ul>\n<li>html2canvas\n<ul>\n<li>doc: <a href=\"https://html2canvas.hertzen.com/\">https://html2canvas.hertzen.com/</a></li>\n<li>git: <a href=\"https://github.com/niklasvh/html2canvas/\">https://github.com/niklasvh/html2canvas/</a></li>\n</ul>\n</li>\n</ul>\n<p>web에서 screenshot을 생성하는 대표적인 lib가 존재합니다. 해당 lib는 screenshot을 생성하기 위한 타겟 dom을 canvas에 draw하여서 screenshot을 생성합니다.</p>\n<p>보통 일반적인 web page의 경우 큰 문제 없이 구동되지만, 복잡한 구조의 page인 경우, 특히 IE에서 아래와 같은 문제가 발생 할 수 있습니다.</p>\n<p><strong>html2canvas의 문제</strong></p>\n<ul>\n<li>svg: svg → canvas로 draw할때, SecurityError가 발생하여, svg가 그려지지 않음\n<ul>\n<li>ref: <a href=\"https://html.spec.whatwg.org/multipage/canvas.html#security-with-canvas-elements\">https://html.spec.whatwg.org/multipage/canvas.html#security-with-canvas-elements</a></li>\n<li>ref: <a href=\"https://github.com/eligrey/canvas-toBlob.js/issues/21\">https://github.com/eligrey/canvas-toBlob.js/issues/21</a></li>\n<li>ref: <a href=\"https://github.com/niklasvh/html2canvas/issues/201\">https://github.com/niklasvh/html2canvas/issues/201</a></li>\n<li><a href=\"https://github.com/niklasvh/html2canvas/issues/1543\">https://github.com/niklasvh/html2canvas/issues/1543</a></li>\n</ul>\n</li>\n<li>image: image → canvas시 canvas의 tainted error가 발생\n<ul>\n<li>ref: <a href=\"https://developer.mozilla.org/en-US/docs/Web/HTML/CORS_enabled_image\">https://developer.mozilla.org/en-US/docs/Web/HTML/CORS_enabled_image</a></li>\n</ul>\n</li>\n</ul>\n<p>html2canvas lib을 IE에서 사용시 특히나 위 문제가 많이 발생합니다. 그 이유는 svg태그를 모두 parsing하고 분석해서 svg → canvas로 직접 draw하는 형태가 아니라. image을 사용하는 trick을 사용하고 있기 때문입니다.</p>\n<ul>\n<li>\n<p>httml2canvas에서 svg의 처리는 아래와 같습니다.</p>\n<ul>\n<li>svg → string으로 변환(serializeToString)</li>\n<li>svg text(string) 을 new image 하고</li>\n<li>image src에 ‘data:image/svg+xml’형태로 설정</li>\n<li>이후 해당 image을 canvas에 drawImage함</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">SVGElementContainer</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">ElementContainer</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">svg</span><span class=\"token operator\">:</span> string<span class=\"token punctuation\">;</span>\n  <span class=\"token literal-property property\">intrinsicWidth</span><span class=\"token operator\">:</span> number<span class=\"token punctuation\">;</span>\n  <span class=\"token literal-property property\">intrinsicHeight</span><span class=\"token operator\">:</span> number<span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token literal-property property\">img</span><span class=\"token operator\">:</span> SVGSVGElement</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span>img<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> s <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">XMLSerializer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>svg <span class=\"token operator\">=</span>\n\t\t\t<span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">data:image/svg+xml,</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token function\">encodeURIComponent</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">.</span><span class=\"token function\">serializeToString</span><span class=\"token punctuation\">(</span>img<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>intrinsicWidth <span class=\"token operator\">=</span> img<span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">.</span>baseVal<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>intrinsicHeight <span class=\"token operator\">=</span> img<span class=\"token punctuation\">.</span>height<span class=\"token punctuation\">.</span>baseVal<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">;</span>\n\n    CacheStorage<span class=\"token punctuation\">.</span><span class=\"token function\">getInstance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">addImage</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>svg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n</li>\n<li>\n<p>위 과정이후 문제가 발생합니다. 위 image → canvas시 tainted error가 발생</p>\n</li>\n</ul>\n<p>결국 html2canvas lib에서의 svg처리 문제로, svg가 잘 그려지지 않는 문제가 발생하고, 근본적으로는 web상에서 canvas가 tained 되었을때, 이를 외부에서 사용가능한 형태로의 변환 시도시 에러가 발생합니다.</p>\n<p>Image을 canvas에 그렸을때 tained 문제</p>\n<ul>\n<li>crossOrigin = “Anonymous”; 설정이 Img 가 onLoad되기 이전에 설정 되어 있어야 해당 문제가 발생하지 않습니다.</li>\n<li>이미 dom 상에 img가 있는데 해당 img에 위 attribute가 없는 경우, img을 xhr로 load하고, load한 data을 읽어서 crossOrigin = “Anonymous” 가 미리 설정된 img을 만들어 해당 img에 다시 이미지를 그리는 형태로 회피를 합니다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token comment\">// proxy 코드 스닙</span>\n<span class=\"token keyword\">private</span> <span class=\"token function\">proxy</span><span class=\"token punctuation\">(</span>src<span class=\"token operator\">:</span> string<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Promise<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>string</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\"> </span><span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> proxy <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_options<span class=\"token punctuation\">.</span>proxy<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>proxy<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'No proxy defined'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">const</span> key <span class=\"token operator\">=</span> src<span class=\"token punctuation\">.</span><span class=\"token function\">substring</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">256</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> responseType <span class=\"token operator\">=</span> <span class=\"token constant\">FEATURES</span><span class=\"token punctuation\">.</span><span class=\"token constant\">SUPPORT_RESPONSE_TYPE</span> <span class=\"token operator\">?</span> <span class=\"token string\">'blob'</span> <span class=\"token operator\">:</span> <span class=\"token string\">'text'</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">const</span> xhr <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">XMLHttpRequest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      xhr<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onload</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>xhr<span class=\"token punctuation\">.</span>status <span class=\"token operator\">===</span> <span class=\"token number\">200</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n              <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>responseType <span class=\"token operator\">===</span> <span class=\"token string\">'text'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                  <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>xhr<span class=\"token punctuation\">.</span>response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n              <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                  <span class=\"token keyword\">const</span> reader <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">FileReader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                  reader<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'load'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>reader<span class=\"token punctuation\">.</span>result <span class=\"token keyword\">as</span> string<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                  reader<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'error'</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">e</span> <span class=\"token operator\">=></span> <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                  reader<span class=\"token punctuation\">.</span><span class=\"token function\">readAsDataURL</span><span class=\"token punctuation\">(</span>xhr<span class=\"token punctuation\">.</span>response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n              <span class=\"token punctuation\">}</span>\n          <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n              <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Failed to proxy resource </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>key<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> with status code </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>xhr<span class=\"token punctuation\">.</span>status<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n\t\t\txhr<span class=\"token punctuation\">.</span><span class=\"token function\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'GET'</span><span class=\"token punctuation\">,</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>proxy<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">?url=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token function\">encodeURIComponent</span><span class=\"token punctuation\">(</span>src<span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">&amp;responseType=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>responseType<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token operator\">...</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// proxy 가 필요한 경우 ==> CORS을 재설정 하는 경우</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>useProxy<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\tsrc <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">proxy</span><span class=\"token punctuation\">(</span>src<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\nLogger<span class=\"token punctuation\">.</span><span class=\"token function\">getInstance</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">debug</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Added image </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>key<span class=\"token punctuation\">.</span><span class=\"token function\">substring</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">256</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">return</span> <span class=\"token keyword\">await</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> img <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Image</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    img<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onload</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>img<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    img<span class=\"token punctuation\">.</span>onerror <span class=\"token operator\">=</span> reject<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">//ios safari 10.3 taints canvas with data urls unless crossOrigin is set to anonymous</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isInlineBase64Image</span><span class=\"token punctuation\">(</span>src<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> useCORS<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        img<span class=\"token punctuation\">.</span>crossOrigin <span class=\"token operator\">=</span> <span class=\"token string\">'anonymous'</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    img<span class=\"token punctuation\">.</span>src <span class=\"token operator\">=</span> src<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>img<span class=\"token punctuation\">.</span>complete <span class=\"token operator\">===</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// Inline XML images may fail to parse, throwing an Error later on</span>\n        <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>img<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">500</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_options<span class=\"token punctuation\">.</span>imageTimeout <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span>\n            <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Timed out (</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_options<span class=\"token punctuation\">.</span>imageTimeout<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">ms) loading image</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_options<span class=\"token punctuation\">.</span>imageTimeout\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><strong>canvas tained?</strong></p>\n<ul>\n<li>canvas에 img나 svg을 draw할때, 해당 svg or img(원본)에 CORS 설정(attribute)을 보고 해당 설정이 없는 원본을 draw한 canvas는 tained된(더럽혀졌어…) canvas로 browser에서 판단됩니다.</li>\n<li>tained된 canvas아래 동작 시도시 Security Error가 발생합니다.\n<ul>\n<li>Calling <code class=\"language-text\">[getImageData()](https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/getImageData)</code> on the canvas’s context</li>\n<li>Calling <code class=\"language-text\">[toBlob()](https://developer.mozilla.org/en-US/docs/Web/API/HTMLCanvasElement/toBlob)</code> on the <code class=\"language-text\">[&lt;canvas>](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/canvas)</code> element itself</li>\n<li>Calling <code class=\"language-text\">[toDataURL()](https://developer.mozilla.org/en-US/docs/Web/API/HTMLCanvasElement/toDataURL)</code> on the canvas</li>\n</ul>\n</li>\n<li>그 이외의 동작은 가능합니다.\n<ul>\n<li>따라서, 원본 소스에서 허락하지 않은 경우, low data변환이나 외부 반출에 제약이 발생합니다.</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"security--tained-error-회피하기\" style=\"position:relative;\"><a href=\"#security--tained-error-%ED%9A%8C%ED%94%BC%ED%95%98%EA%B8%B0\" aria-label=\"security  tained error 회피하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>security &#x26; tained error 회피하기</h3>\n<p><strong>canvg</strong></p>\n<p>canvg는 svg을 canvas로 변경해주는 대표적인 lib 입니다. html2canvas와 다르게 canvg는 svg의 내용을 직접 parsing하고 해석하여, 해당 그림을 canvas에 그려줍니다.</p>\n<ul>\n<li>git: <a href=\"https://github.com/canvg/canvg\">https://github.com/canvg/canvg</a></li>\n</ul>\n<p>canvg가 생성하는 canvas에 그려진 svg는 실질적으로는 canvas에 메뉴얼하게 그린 pure한 canvas이기 때문에 security나 tained error가 발생하지 않습니다.</p>\n<p><strong>html2canvas + canvg 조합하여 회피하기</strong></p>\n<p>html2canvas에서는, 목적하는 dom을 clone하여 이용하고, 해당 cloned dom은 canvas로 그려지기 전에 수동으로 이미지, 스타일 등을 조정 할 수 있는 callback api을 제공합니다.</p>\n<p>따라서, html2canvas에 svg부분만 canvg로 그려서 대체하면, 실질적으로 html2canvas을 이용해서 이미지를 생성 할 수 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"glsl\"><pre class=\"language-glsl\"><code class=\"language-glsl\"><span class=\"token comment\">// pseudo code</span>\n<span class=\"token function\">html2canvas</span><span class=\"token punctuation\">(</span>targetElement<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n\tonclone<span class=\"token operator\">:</span> clonedDoc <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n\t  <span class=\"token comment\">// svg to canvas</span>\n\t\t<span class=\"token keyword\">const</span> svg <span class=\"token operator\">=</span> clonedDoc<span class=\"token punctuation\">.</span><span class=\"token function\">querySelector</span><span class=\"token punctuation\">(</span><span class=\"token char\">'svg'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>svg<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> canvas <span class=\"token operator\">=</span> Canvg<span class=\"token punctuation\">.</span><span class=\"token function\">fromString</span><span class=\"token punctuation\">(</span>svg<span class=\"token punctuation\">.</span>innerHTML<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token keyword\">const</span> parent <span class=\"token operator\">=</span> svg<span class=\"token punctuation\">.</span>parentElement<span class=\"token punctuation\">;</span>\n\t\t\tsvg<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      parent<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>canvas<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"dom-to-canvas\" style=\"position:relative;\"><a href=\"#dom-to-canvas\" aria-label=\"dom to canvas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>DOM to Canvas</h3>\n<p>dom object을 canvas에 그리는 가장 일반 적인 방법을 소개합니다.</p>\n<p>참고: <a href=\"http://man.hubwiz.com/docset/JavaScript.docset/Contents/Resources/Documents/developer.mozilla.org/en-US/docs/Web/API/Canvas_API/Drawing_DOM_objects_into_a_canvas.html\">http://man.hubwiz.com/docset/JavaScript.docset/Contents/Resources/Documents/developer.mozilla.org/en-US/docs/Web/API/Canvas_API/Drawing_DOM_objects_into_a_canvas.html</a></p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">const</span> <span class=\"token constant\">DOMURL</span> <span class=\"token operator\">=</span> window<span class=\"token punctuation\">.</span><span class=\"token constant\">URL</span> <span class=\"token operator\">||</span> window<span class=\"token punctuation\">.</span>webkitURL <span class=\"token operator\">||</span> window<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> canvas <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">'canvas'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> ctx <span class=\"token operator\">=</span> canvas<span class=\"token punctuation\">.</span><span class=\"token function\">getContext</span><span class=\"token punctuation\">(</span><span class=\"token string\">'2d'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\ncanvas<span class=\"token punctuation\">.</span>width <span class=\"token operator\">=</span> <span class=\"token number\">200</span><span class=\"token punctuation\">;</span>\ncanvas<span class=\"token punctuation\">.</span>height <span class=\"token operator\">=</span> <span class=\"token number\">200</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> data <span class=\"token operator\">=</span>\n\t\t <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">&lt;svg xmlns=\"http://www.w3.org/2000/svg\" width=\"200\" height=\"200\">\n        &lt;foreignObject width=\"100%\" height=\"100%\">\n          &lt;div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"font-size:40px\">\n            &lt;em>I&lt;/em> like\n            &lt;span style=\"color:white; text-shadow:0 0 2px blue;\">\n            cheese&lt;/span>\n          &lt;/div>\n        &lt;/foreignObject>\n      &lt;/svg></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> svg <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Blob</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>data<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span><span class=\"token literal-property property\">type</span><span class=\"token operator\">:</span> <span class=\"token string\">'image/svg+xml;charset=utf-8'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span> <span class=\"token constant\">DOMURL</span><span class=\"token punctuation\">.</span><span class=\"token function\">createObjectURL</span><span class=\"token punctuation\">(</span>svg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> img <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Image</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nimg<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onload</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  ctx<span class=\"token punctuation\">.</span><span class=\"token function\">drawImage</span><span class=\"token punctuation\">(</span>img<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token constant\">DOMURL</span><span class=\"token punctuation\">.</span><span class=\"token function\">revokeObjectURL</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\nimg<span class=\"token punctuation\">.</span>src <span class=\"token operator\">=</span> url<span class=\"token punctuation\">;</span>\n\ndocument<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>canvas<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li>svg의 foreignObject을 이용하여 내부에 dom을 그리고, svg → image → canvas에 그리는 형태입니다.</li>\n<li>단 IE에서는 지원하지 않고 있습니다. ref: <a href=\"https://caniuse.com/#search=foreignobject\">https://caniuse.com/#search=foreignobject</a></li>\n<li>html2canvas의 경우, foreignObject을 지원하는 경우 위와 같은 방법으로 canvas에 그리고, 만약 foreignObject을 지원하지 않는 경우, dom tree을 모두 parsing하면서 각각의 element type에 따라서, size(bound), style, text등을 계산하여 직접 canvas에 그림을 그립니다. ref: <a href=\"https://github.com/niklasvh/html2canvas/blob/master/src/render/canvas/canvas-renderer.ts\">https://github.com/niklasvh/html2canvas/blob/master/src/render/canvas/canvas-renderer.ts</a></li>\n</ul>\n<h3 id=\"정리\" style=\"position:relative;\"><a href=\"#%EC%A0%95%EB%A6%AC\" aria-label=\"정리 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>정리</h3>\n<ul>\n<li>DOM → Image(Canvas)는 foreignObject을 사용하는 경우 생각보다 어렵지 않게 변환 가능합니다.</li>\n<li>DOM에 SVG나 Image가 존재하는 경우 Security 문제가 있을 수 있습니다.\n<ul>\n<li>Image: attribute에 crossOrigin = “Anonymous”; 설정으로 회피 가능 합니다.</li>\n<li>svg: canvg등으로 svg → canvas로 직접 그리는 형태로 회피 가능 합니다.</li>\n</ul>\n</li>\n<li>대다수의 간략한 DOM Tree의 경우 문제없이 기본적인 lib사용으로 이미지 생성이 가능합니다.</li>\n<li>만약 SVG나 Image에 의해 문제가 발생할 경우 위와 같은 회피 방법을 활용하여 이미지 생성을 할 수 있습니다.</li>\n</ul>\n<h3 id=\"추가사항\" style=\"position:relative;\"><a href=\"#%EC%B6%94%EA%B0%80%EC%82%AC%ED%95%AD\" aria-label=\"추가사항 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>추가사항</h3>\n<ul>\n<li>html2canvas의 경우, 내부적으로 target이 되는 dom tree만 clone하는게 아니라. full window(document)을 모두 clone하여 동작합니다. 따라서 document의 크기에 따라서, document의 dom tree가 매우 복잡하고 많은 경우, 500ms 이상 느리게 동작 할 수 있습니다.</li>\n<li>이미지 생성을 해야하는 부분에 DOM보다는 SVG나 Image로만 되어 있다면, 직접 SVG, Image를 Canvas에 그려서 이미지로 생성하는게 성능상 이점이 큽니다.</li>\n</ul>\n<div class=\"table-of-contents\">\n<ul>\n<li><a href=\"#%EC%86%8C%EA%B0%9C\">소개</a></li>\n<li><a href=\"#web%EC%97%90%EC%84%9C-%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7-%EC%83%9D%EC%84%B1%ED%95%98%EB%8A%94-lib\">Web에서 스크린샷 생성하는 Lib</a></li>\n<li><a href=\"#security--tained-error-%ED%9A%8C%ED%94%BC%ED%95%98%EA%B8%B0\">security &#x26; tained error 회피하기</a></li>\n<li><a href=\"#dom-to-canvas\">DOM to Canvas</a></li>\n<li><a href=\"#%EC%A0%95%EB%A6%AC\">정리</a></li>\n<li><a href=\"#%EC%B6%94%EA%B0%80%EC%82%AC%ED%95%AD\">추가사항</a></li>\n</ul>\n</div>","excerpt":"소개 svg, canvas, 일반 DOM이 섞여 있는 Web Page을 브라우저에서 screenshot을 생성하기 위한 web tech tip에 대해서 이야기 합니다. Web에서 스크린샷 생성하는 Lib html2canvas doc: https://html2canvas.hertzen.com/ git: https://github.com/niklasvh/html2canvas/ web에서 screenshot을 생성하는 대표적인 lib가 존재합니다. 해당 lib는 screenshot을 생성하기 위한 타겟 dom을 canvas에 draw하여서 screenshot을 생성합니다. 보통 일반적인 web page의 경우 큰 문제 없이 구동되지만, 복잡한 구조의 page인 경우, 특히 IE에서 아래와 같은 문제가 발생 할 수 있습니다. html2canvas의 문제 svg: svg → canvas로 draw할때, SecurityError가 발생하여, svg가 그려지지 않음 ref: https://ht…","frontmatter":{"date":"January 10, 2020","title":"DOM 스샷찍기(Svg & Canvas & DOM)","categories":"tech-talk","author":"gseok","emoji":null},"fields":{"slug":"/tech-talk-2020/2020-01-10-DOM-screenshot/"}},"next":{"id":"47b6e5e2-4ec0-5981-9013-b310a46af38c","html":"<h2 id=\"소개\" style=\"position:relative;\"><a href=\"#%EC%86%8C%EA%B0%9C\" aria-label=\"소개 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>소개</h2>\n<p>약간 시대에 뒤떨어지는 UI/UX &#x26; 사용법으로, 사용자들이 많이 이탈하였지만, 아직도 Top20 등으로 CI/CD Tool검색시 항상 포함되는 정통의 강자가 Jenkins 이다. 여기서는, Jenkins의 Abort(Cancel) action에 대한 후처리(post control or after control)를 별도의 plugin설치 없이 simple하게 하는 방법에 대하여 설명한다.</p>\n<h2 id=\"why-needed\" style=\"position:relative;\"><a href=\"#why-needed\" aria-label=\"why needed permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>why needed?</h2>\n<ul>\n<li>현재 프로젝트에서, 서버로 API를 쏘는 CLI을 사용중인데, Jenkins에서 Cancel하여도, 실제 Build or Deploy동작은 Cancel되지 않는 문제가 있음.</li>\n<li>해결방법으로, Jenkins에서 Cancel하면, 해당 동작을 감지하여 서버에 Cancel API을 호출하여 실제 Build or Deploy동작을 Cancel처리 하고자 함.</li>\n</ul>\n<h2 id=\"pre-required-knowledge\" style=\"position:relative;\"><a href=\"#pre-required-knowledge\" aria-label=\"pre required knowledge permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>pre required knowledge</h2>\n<p><strong>Jenkins 관련</strong></p>\n<ul>\n<li>Jenkins Basic\n<ul>\n<li>open source: <a href=\"https://github.com/jenkinsci/jenkins\">https://github.com/jenkinsci/jenkins</a></li>\n<li>Java Program (war), <code class=\"language-text\">java -jar jenkins.war --httpProt=8080</code></li>\n<li>Java 8 이상 환경에서 어디서나 실행 가능(Multiple OS Support)</li>\n<li><a href=\"https://blog.knoldus.com/setting-up-master-slave-machines-using-jenkins/\">분산 빌드 지원</a></li>\n<li><a href=\"https://plugins.jenkins.io/\">다양한 플러그인 지원</a></li>\n<li><a href=\"https://jenkins.io/doc/developer/tutorial/extend/\">커스텀 플러그인 지원</a></li>\n</ul>\n</li>\n<li>Jenkins Build Step (Execute Shell)\n<ul>\n<li>사실 Java에서 <code class=\"language-text\">Runtime.exec</code> or <code class=\"language-text\">ProcessBuilder</code>와 다를바 없음</li>\n<li>즉 하나의 Execute Shell은 하나의 <code class=\"language-text\">Child Process</code>가 되어 독립적으로 수행됨</li>\n</ul>\n</li>\n</ul>\n<p><strong>Kubernetes 관련</strong></p>\n<ul>\n<li>Kubectl CLI\n<ul>\n<li>쿠버네티스를 컨트롤 할수 있는 CLI Tool</li>\n<li><code class=\"language-text\">kubectl</code> 명령어로 Kubernetes Cluster와 상호 작용 할 수 있다.</li>\n<li><code class=\"language-text\">kubectl</code>은 실질적으로는 <a href=\"https://kubernetes.io/ko/docs/tutorials/kubernetes-basics/deploy-app/deploy-intro/\">Kubernetes의 API</a>를 사용한다.\n<ul>\n<li><a href=\"https://kubernetes.io/ko/docs/concepts/overview/kubernetes-api/\">API 설명</a></li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"problem\" style=\"position:relative;\"><a href=\"#problem\" aria-label=\"problem permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>problem</h2>\n<ul>\n<li>jenkins의 build step에서 kubernetes의 helm등을 수행했을때, 사용자가 jenkins job을 <code class=\"language-text\">cancel(abort)</code> 한경우, jenins job은 stop되지만, <code class=\"language-text\">helm run은 cancel되지 않는</code> 문제가 있음</li>\n<li>원인은 위 기본 개념에서 말했듯, 실질적으로 kubectl command가 api call이기때문에, 명령어가 kubernetes cluster에 들어가고 나서 취소 명령어가 들어오기 전까지는 계속 수행이 되고 있기 때문임</li>\n</ul>\n<h2 id=\"solution\" style=\"position:relative;\"><a href=\"#solution\" aria-label=\"solution permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>solution</h2>\n<ul>\n<li>jenkins의 cancel동작시 해당 동작을 감지하고, any action을 할 수 있게 하면 됨</li>\n</ul>\n<p><strong>Jenkins Abort Action</strong></p>\n<ul>\n<li>jenkins에서 cancel을 누르면, <code class=\"language-text\">TERM</code> 시그널을 현재 Job의 process group에 발생시킨다.</li>\n<li>이후 해당 job에서 수행(spawns)한 subprocess는 모두 <code class=\"language-text\">TERM</code>이 되고, “Finished: ABORTED” 메시지를 출력하면서, jenkins의 job 수행이 stop된다.</li>\n</ul>\n<p><strong>TERM Signal Handle</strong></p>\n<ul>\n<li>singal은 unix계열의 운영체제에서, IPC용도 혹은, process control을 위해 만들어진 async한 event(signal)이다.</li>\n<li>unix계열의 운영체제에서는 이러한 signal을 핸들링 할수 있는 <code class=\"language-text\">C</code>함수(System Call API) 및 CLI command(user command)명령어을 제공한다.</li>\n<li>signal 핸들링 명령어중 <code class=\"language-text\">[trap](http://man7.org/linux/man-pages/man1/trap.1p.html)</code>은 시그널 발생을 감지하여, command을 실행하는게 가능한 명령어 이다.</li>\n</ul>\n<p><strong>Jenkins에서 Abort감지해서 사용자정의 동작하게 하기</strong></p>\n<ul>\n<li>위 내용들을 조합하여 아래와 같은 간략한 script을 통해서, jenkins의 abort을 감지하고, 감지이후 사용자정의 동작을 구현 할 수 있다.</li>\n<li>아래코드는 jenkins의 excutable script의 한 예이다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/bin/bash</span>\n\n<span class=\"token comment\"># abort control #######################################################</span>\n<span class=\"token function-name function\">getAbort</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"--- Caution!! Abort detected ---\"</span>\n <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"> Launch The Post Script for Jenkins Aborted after 3sec\"</span>\n\n <span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">i</span> <span class=\"token keyword\">in</span> <span class=\"token punctuation\">{</span><span class=\"token number\">1</span><span class=\"token punctuation\">..</span><span class=\"token number\">3</span><span class=\"token punctuation\">}</span>\n <span class=\"token keyword\">do</span>\n   <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\".\"</span>\n   <span class=\"token function\">sleep</span> <span class=\"token number\">1</span>\n <span class=\"token keyword\">done</span>\n\n <span class=\"token assign-left variable\">PENDING_NAME</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">`</span>kubectl get build <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> some-dev- <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> Pending <span class=\"token operator\">|</span> <span class=\"token function\">awk</span> <span class=\"token string\">'{print $1}'</span><span class=\"token variable\">`</span></span>\n <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span> -z <span class=\"token string\">\"<span class=\"token variable\">$PENDING_NAME</span>\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"PENDING_NAME is Empty\"</span>\n <span class=\"token keyword\">else</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">'Build: '</span><span class=\"token string\">\"<span class=\"token variable\">$PENDING_NAME</span>\"</span>' is Canceled<span class=\"token string\">'\n    kubectl pipeline cancel $PENDING_NAME\n fi\n}\ntrap '</span>getAbort<span class=\"token punctuation\">;</span> exit' SIGHUP SIGINT SIGTERM\n<span class=\"token comment\">######################################################################</span>\n\n\n<span class=\"token comment\"># check current cluster</span>\nkubectl get pods\n\n<span class=\"token comment\"># This Step is real Build &amp; Deploy</span>\n<span class=\"token comment\"># run pipeline</span>\n<span class=\"token comment\"># 핵심은 jenkins로 아래와 같이 kubernates의 pipeline빌드를 돌리다가.</span>\n<span class=\"token comment\"># kubernates가 아닌 jenkins에서 stop(cancel)을 시켯을때</span>\n<span class=\"token comment\"># kubernates도 stop시키기임, jenkins의 stop버튼은 위의 getAbort가 감지하고</span>\n<span class=\"token comment\"># kubectl pipeliine cancel로 stop시킨다.</span>\n<span class=\"token comment\"># 따라서 jenkins도 stop되고, 실제 kubernates pipe도 stop된다.</span>\nkubectl pipeline run --skip-approval --wait some-dev-project\n\n<span class=\"token comment\"># These Steps are checking the Build &amp; Deploy</span>\n<span class=\"token comment\"># check pipeline result</span>\nkubectl get instance\nkubectl get <span class=\"token function\">service</span>\nkubectl get pods\n\n<span class=\"token comment\"># ping test</span>\n<span class=\"token function\">curl</span> --insecure -v https://some-project/ping\n<span class=\"token comment\"># 특이하게도, jenkins의 Execute shell step에서 trap 명령어 하위에, 또다른 명령어 하나가 있어야 정상 동작하는 경우가 있음. 간단히 print하는걸 넣어주면됨.</span>\n</code></pre></div>\n<ul>\n<li>위와같은 상황에서, Jenkins UI상에서 Cancel수행시 정상적으로, abort을 감지하여 <code class=\"language-text\">getAbort</code>함수가 수행되는것을 확인 할 수 있다.</li>\n</ul>\n<h2 id=\"refrence\" style=\"position:relative;\"><a href=\"#refrence\" aria-label=\"refrence permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>refrence</h2>\n<ul>\n<li>Jenkins: <a href=\"https://jenkins.io/doc/\">https://jenkins.io/doc/</a></li>\n<li>Kubernetes: <a href=\"https://kubernetes.io/ko/docs\">https://kubernetes.io/ko/docs</a></li>\n<li>Jenkins Abort\n<ul>\n<li>stackoverflow: <a href=\"https://stackoverflow.com/questions/32065516/detect-jenkins-build-abort-event\">https://stackoverflow.com/questions/32065516/detect-jenkins-build-abort-event</a></li>\n<li>when you cancel a jenkins job: <a href=\"https://gist.github.com/datagrok/dfe9604cb907523f4a2f\">https://gist.github.com/datagrok/dfe9604cb907523f4a2f</a></li>\n</ul>\n</li>\n<li>signal: <a href=\"https://en.wikipedia.org/wiki/Signal_(IPC)\">https://en.wikipedia.org/wiki/Signal_(IPC)</a></li>\n<li>signal api: <a href=\"http://man7.org/linux/man-pages/man2/signal.2.html\">http://man7.org/linux/man-pages/man2/signal.2.html</a></li>\n<li>signal man 2 and 7: <a href=\"https://stackoverflow.com/questions/25828288/what-is-the-difference-between-signal7-and-signal2\">https://stackoverflow.com/questions/25828288/what-is-the-difference-between-signal7-and-signal2</a></li>\n<li>linux trap: <a href=\"https://www.joinc.co.kr/w/Site/Tip/Signal_trap\">https://www.joinc.co.kr/w/Site/Tip/Signal_trap</a></li>\n<li>linux trap man: <a href=\"http://man7.org/linux/man-pages/man1/trap.1p.html\">http://man7.org/linux/man-pages/man1/trap.1p.html</a></li>\n</ul>\n<div class=\"table-of-contents\">\n<ul>\n<li><a href=\"#%EC%86%8C%EA%B0%9C\">소개</a></li>\n<li><a href=\"#why-needed\">why needed?</a></li>\n<li><a href=\"#pre-required-knowledge\">pre required knowledge</a></li>\n<li><a href=\"#problem\">problem</a></li>\n<li><a href=\"#solution\">solution</a></li>\n<li><a href=\"#refrence\">refrence</a></li>\n</ul>\n</div>","frontmatter":{"date":"October 21, 2019","title":"Jenkins Abort","categories":"tech-talk ci","author":"gseok","emoji":"🧢"},"fields":{"slug":"/tech-talk-2019/2019-10-21-Jenkins-Abort/"}},"prev":{"id":"366897ce-21b8-574c-a6bf-00144a11fcfd","html":"<h3 id=\"소개\" style=\"position:relative;\"><a href=\"#%EC%86%8C%EA%B0%9C\" aria-label=\"소개 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>소개</h3>\n<p>node project을 진행중에 폴더 구조 변경 이후 아래와 같이 “breakpoint ignored” 가 발생하면서, 코드 디버깅을 IDE(vscode, intellij, 등)에서 하지 못하는 문제가 발생하였다. 하여 해당 문제의 발생 원인 및 해결 방법에 대해서 간략하게 설명한다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 574px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 30.555555555555554%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA9klEQVQY02VQW26DMBDMQTD22rvrtcE86gYIFNM0Ue9/pCrNRyp1NJq/eWhORKy1BgDvOMeREH0a2veFvI8YWpJeyBijlKr/4UTEda3ROWQB36Yu5Nx5IQniY2ObgCkioyMCMPqFXzMihRhLKfvxuZbr/f51vx2367GXY9uPpZRp/5gv67Ju5/OU36d5WS6XNYRQVdWj2RiDyN5Dd+67ee/HvORxiELWJk+BsPEUGSNTIxyY2DkLoJ6ztdbWOhHo57d8fA/TOg3dNrTbmMZGhFxkFHRCTtCxswgAxtR/zZ4hJQFHWmsEbQHcI15XSr1YPVTV9fO9HziMOG4OnaB4AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"01\"\n        title=\"01\"\n        src=\"/static/10f28b9b3e811ac4a0ffac68a767bc4a/86389/01.png\"\n        srcset=\"/static/10f28b9b3e811ac4a0ffac68a767bc4a/e9ff0/01.png 180w,\n/static/10f28b9b3e811ac4a0ffac68a767bc4a/f21e7/01.png 360w,\n/static/10f28b9b3e811ac4a0ffac68a767bc4a/86389/01.png 574w\"\n        sizes=\"(max-width: 574px) 100vw, 574px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<h3 id=\"원인\" style=\"position:relative;\"><a href=\"#%EC%9B%90%EC%9D%B8\" aria-label=\"원인 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>원인</h3>\n<p>해당 문제가 발생하는 이유는 ts이건 js이건 빌드 이후 생성한 debug용 “*.map” 파일에 기록되어 있는,  <strong>원본(original) 코드 위치 및 loader위치가, 실제 해당 프로젝트의 원본 코드(original code)의 위치가 맞지 않아서 발생</strong>하는 문제이다.</p>\n<p>해당 문제가 발생했을때, 상황을 좀더 빠르게 확인하려면, dubug용 빌드시 명확하게 path가 보이는 옵션으로 빌드하여 “*.map” 파일을 열어서 확인해보는게 좋다.</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token comment\">// webpack을 사용하는 경우 devtool 설정을 \"source-map\" 으로 한다.</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">devtool</span><span class=\"token operator\">:</span> <span class=\"token string\">\"source-map\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>문제가 발생하는 경우 예제</p>\n<ul>\n<li>원본 소스 위치: /packages/pr-server/src/routes/ping.route.ts</li>\n<li>디버그 map파일에 기록된 소스 위치: webpack:///./src/routes/ping.route.ts</li>\n<li>빌드 결과 위치\n<ul>\n<li>/dist/pr-server/server.js</li>\n<li>/dist/pr-server/server.js.map</li>\n</ul>\n</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 569px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 16.11111111111111%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAIAAAAcOLh5AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAm0lEQVQI1yWIaxKCIBgAvYiOPLPG8QF8gBYooqZW979OY+2PnZ1NOn1VYACgqiqMMSb0VlBGCUKYnFBCCP4lo4xgkucIIfSfCS9uZVm2bSulBABtrJF89HYM0ftBKrBd7/zQ9adBm7pu6rrh/MIYS9I0zbJMKeWcs9Yao4WQ94c7Xp/9eA8hjiGGOC/rNi/PMM1TXNZtH8MkhPgCU8IjNZBY3uoAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"02\"\n        title=\"02\"\n        src=\"/static/df81f4277f98e739e23ba3f1ba5b5fa2/854dc/02.png\"\n        srcset=\"/static/df81f4277f98e739e23ba3f1ba5b5fa2/e9ff0/02.png 180w,\n/static/df81f4277f98e739e23ba3f1ba5b5fa2/f21e7/02.png 360w,\n/static/df81f4277f98e739e23ba3f1ba5b5fa2/854dc/02.png 569w\"\n        sizes=\"(max-width: 569px) 100vw, 569px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>위 예제와 같은 경우 IDE(vscode, intellij, 등)에서는 map파일에 기록된 소스 위치로 원본 소스를 찾게 되는데, 실제 위치에 해당 파일이 없기 때문에 debug point가 정상 동작하지 않게 된다.</p>\n<h3 id=\"해결-방법\" style=\"position:relative;\"><a href=\"#%ED%95%B4%EA%B2%B0-%EB%B0%A9%EB%B2%95\" aria-label=\"해결 방법 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>해결 방법</h3>\n<p>원인이 명확하기 때문에 원인을 해결하면 문제를 해결 할 수 있다. 원인을 해결 하는 방법은 아래와 같이 2가지가 존재 할 수 있다.</p>\n<ol>\n<li><strong>IDE에서 map파일에 기록된 path을, 실제 original source file 위치로 다시 mapping</strong></li>\n<li><strong>build시점에 debug용 source map을 생성할때, 명확한 source path로 map파일이 생성되도록 설정</strong></li>\n</ol>\n<p>사용하고 있는 IDE와, bundler에 따라서 조금씩 방법이 다르겠지만, 핵심은 결국 위 2가지 방법으로 해결 할 수 있다. 여기서는 IDE(vscode) 인 경우와, bundler(webpack)인 경우 해결 방법에 대해서 설명한다.</p>\n<p><strong>IDE(VSCode)설정을 이용해서, debug 파일(*.map)의 path을 설정하기</strong></p>\n<p>VSCode의 경우 debug launch을 할때, “launch.json” 에 debug run configuration을 설정할 수 있다. 이때  launch.json의 “sourceMapPathOverrides” 설정을 이용해서, debug point 미스 매칭을 해결 할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token comment\">// vscode의 launch.json 설정 예제</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token string-property property\">\"version\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"0.2.0\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string-property property\">\"configurations\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token string-property property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"node\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string-property property\">\"request\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"attach\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string-property property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Attach by Process ID\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string-property property\">\"protocol\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"inspector\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string-property property\">\"port\"</span><span class=\"token operator\">:</span> <span class=\"token number\">9331</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string-property property\">\"restart\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n\n      <span class=\"token comment\">// 아래 3개의 설정을 추가해 주면 된다. 그중 핵심은 \"sourceMapPathOverrides\" 설정이다.</span>\n      <span class=\"token string-property property\">\"sourceMaps\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string-property property\">\"trace\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string-property property\">\"sourceMapPathOverrides\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token string-property property\">\"webpack:///./src/*\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"${workspaceRoot}/packages/pr-server/src/*\"</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>위 예제의 경우, 디버그 “*.map” 파일에 <strong>미스 매칭된 relative path을 실제 origin source code path로 설정</strong>해 주고 있다.</p>\n<p>이후 vscode에서 debug launch을 시도해보면 정상적으로 debug point가 기동됨을 확인 할 수 있다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 642px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 71.66666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAAsTAAALEwEAmpwYAAACAElEQVQoz3WR246bMBRF+Y0GGwi+ge8GA8YOGaZkopGqXh7ah/7/j1Qk03baTreWZMny0j46zpZlMcYOwzinGKYw7QneD1IqY6wQYvQmpRRCMMaUqo/pNM+zEJzrLptC0MbEmGJMhNC/QAgTSrngQkrvvVbKGK21llIKIbIwDlKI8/khxrg//VPGmBRFUVWVE85xoztvwyK0scJqxrNpvXI7OOusdW/KVVXVdX3ElLXM2qZpMaWYtgzJJguPV+FGVNf/zowJZZRwusvnTX36vn3+evryQa5rfX4kaSPZ48dvejzFELQ2hFBK2WsIoVVVobqWBpk5qG7orXacNqTWDc7mtEj1or1RfhsbI6Q07c+r8nNvVDDi1GnBaJZSVFLhfam/5V/NGJOyLAnBUjFYwEP+DoD8kIPDIQcAZOu6KqXrGiGEMSb3NoTwnds9Yoxx2ja44ZQ3mAnOpGyPVZXFGM3+d6brOs45xoSxxlprjO26nrf8eDzuPqINZi1pGaZCNLt8vMneT+v6ftuuzg1KWeeGy+X56en5crmmdIYQlmUJILgDIQA5yHMAIcz6vpdSzXPatidru3mOwzDFmFJaluUhxhMAoCiKsih/cj/Koigy7z3nwloXY1JKez9Ya7XW1tpxnPre3+U38yJ7P6zr6lw3TaHv/S3DNE1CSAjh/+QfgD6NeS34jF4AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"03\"\n        title=\"03\"\n        src=\"/static/2e03a630aaeb5e8ad48d1b58c9c9d55c/1bba8/03.png\"\n        srcset=\"/static/2e03a630aaeb5e8ad48d1b58c9c9d55c/e9ff0/03.png 180w,\n/static/2e03a630aaeb5e8ad48d1b58c9c9d55c/f21e7/03.png 360w,\n/static/2e03a630aaeb5e8ad48d1b58c9c9d55c/1bba8/03.png 642w\"\n        sizes=\"(max-width: 642px) 100vw, 642px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p><strong>Bundler(Webpack)설정을 변경하여, debug 파일(*.map)생성시 path을 명확하게 설정하기</strong></p>\n<p>webpack의 경우, debug 설정을 “devtool” 을 사용하게 되어 있는데, 이때 output설정에 “devtool”의 부가 설정이 가능하다.</p>\n<p>참고: <a href=\"https://webpack.js.org/configuration/output/#outputdevtoolmodulefilenametemplate\">https://webpack.js.org/configuration/output/#outputdevtoolmodulefilenametemplate</a></p>\n<p>가장 간단한 방법은 아래 예제와 같이 <strong>webpack의 output설정중 devtoolModuleFilenameTemplate 설정을 absolute path로</strong> 주는 형태이다.</p>\n<p>예제</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token comment\">// webpack.config.js</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">devtool</span><span class=\"token operator\">:</span> <span class=\"token string\">\"source-map\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">output</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">path</span><span class=\"token operator\">:</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>rootPath<span class=\"token punctuation\">,</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">dist/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>packageJSON<span class=\"token punctuation\">.</span>name<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">filename</span><span class=\"token operator\">:</span> <span class=\"token string\">'[name].js'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">chunkFilename</span><span class=\"token operator\">:</span> <span class=\"token string\">'[name].js'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token comment\">// 아래 devtoolModuleFilenameTemplate 설정이 핵심이다.</span>\n    <span class=\"token literal-property property\">devtoolModuleFilenameTemplate</span><span class=\"token operator\">:</span> <span class=\"token string\">'[absolute-resource-path]'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token operator\">...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>위 예제와 같은 형태로 build시도시 아래와 같이 absoulte path설정이 된 debug “*.map” 파일을 볼 수 있다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 663px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 18.88888888888889%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAt0lEQVQI1yWMy2rDMBBF/R/2pnqMXBVNpEojS5Ecx4FAoPS1Cll00///iFLpcBguXO4MKXqiGELgXEip5hkAQIL6V0IXWhZCdjkXAIqIBoNojMF2DR7Icv9qzIs2Ws0gnHO91fr5qcEYk/2fmodxHBFx27baiDHWWi+fP+vX7/7xOB7zqbE29n0vpVhrQwjW2mGaJkRMKS3LknMmolrr+fZ9fruv13fnXErJe09EpZSUc59prRljf1NELcFkOx9cAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"04\"\n        title=\"04\"\n        src=\"/static/33010dfe1e34eca985ec63b09528695a/0786c/04.png\"\n        srcset=\"/static/33010dfe1e34eca985ec63b09528695a/e9ff0/04.png 180w,\n/static/33010dfe1e34eca985ec63b09528695a/f21e7/04.png 360w,\n/static/33010dfe1e34eca985ec63b09528695a/0786c/04.png 663w\"\n        sizes=\"(max-width: 663px) 100vw, 663px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>해당 설정에서 IDE의 기본설정으로 아래와 같이 break point가 정상 동작됨을 확인 할 수 있다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 323px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 61.11111111111111%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsTAAALEwEAmpwYAAACIklEQVQozy3Q2Y7bIBQG4DxFOzEGvIDBGG+A8YLjZLJHaTuZqqNK7dz2/V+hYtr/CnH0if+wohF66k5g9zZb3dm+7/txHLXWnDPGWLt/GDtM4+B85mHwh67rpCyrqlzRJAl4g5txt3GbZZmmyTmnlEqShBAizdQqPY0+8zxba/9NGWNC5KuU0DTCk3M8F50xaUoYY1rrvu+11oyS9iPWWkJIWZaccyGEc24cxxUhFEcRyRilVAghpazrWpbS9lYrLfK8qWsh8qos/b2vWxayyBgjlHqMEIIQRlEUBEGRF4MZalkbpbVRyg7T8lw2qlams11bt6MZdKuyJKZJ/B8jjBljEEGZFef+5JpZ8kKWvJl2dn+1+6s0oygyyYql3ZS8MiU/T+ajttcoyzKMIwhBCJ5gGIAQBAEAQbBer0GwhiEIQwCCpxACCAI/CwKPQ+hxzjnGKKJF1swR11Ull42Z585aJWVJ07TWbdVvCWXpYIntUqM9lgxF2L+MEFZddvzm3Hn8+ujf3k+Xu3o81P1WORdtn7P9RW02dLoU7iLdtfJ4qyGJEc9zhOJlBm+/xOvv+fv78uPP4+Xn+OWe3m/4eFofDp8P+0+3W3w9h5cjuJzCFaUZ+KjNGEMIFwWpFC2MVtMujiORoE1THLpGyQJFMQhRCOE6hIFfHXqM/WdjKaXHIq0UrZ2bLi/T7bU/3IbjjWf0YNvFNGMjW8GPvdqauivFX3MxgXptS4I1AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"05\"\n        title=\"05\"\n        src=\"/static/62a4452ff6f1f1916326bba87c4b4c8b/89aeb/05.png\"\n        srcset=\"/static/62a4452ff6f1f1916326bba87c4b4c8b/e9ff0/05.png 180w,\n/static/62a4452ff6f1f1916326bba87c4b4c8b/89aeb/05.png 323w\"\n        sizes=\"(max-width: 323px) 100vw, 323px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<h3 id=\"요약\" style=\"position:relative;\"><a href=\"#%EC%9A%94%EC%95%BD\" aria-label=\"요약 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>요약</h3>\n<ul>\n<li>원인: debug 정보상 원본 source 에 대한 path 미스 매칭</li>\n<li>해결: path미스매칭을 맞추어 주면 됨\n<ul>\n<li>IDE의 debug run 설정에서 맞추거나</li>\n<li>Bundler에서 debug 모드 빌드시 map 파일의 path설정을 맞추어 줌</li>\n</ul>\n</li>\n<li>추가: 각 IDE와 bundler마다 설정방법이 다를수 있다. 해당 부분은 잘 찾아서 맞추어 주어야 한다. 여기서는  vscode와 webpack 사용시 해결방법에 대하여 설명하였다.</li>\n</ul>\n<div class=\"table-of-contents\">\n<ul>\n<li><a href=\"#%EC%86%8C%EA%B0%9C\">소개</a></li>\n<li><a href=\"#%EC%9B%90%EC%9D%B8\">원인</a></li>\n<li><a href=\"#%ED%95%B4%EA%B2%B0-%EB%B0%A9%EB%B2%95\">해결 방법</a></li>\n<li><a href=\"#%EC%9A%94%EC%95%BD\">요약</a></li>\n</ul>\n</div>","frontmatter":{"date":"February 06, 2020","title":"Debug breakpoint ignored 문제 수정","categories":"tech-talk troubleshooting","author":"gseok","emoji":null},"fields":{"slug":"/tech-talk-2020/2020-02-06-Debug-breakpoint-ignored/"}},"site":{"siteMetadata":{"siteUrl":"https://gseok.github.io","comments":{"utterances":{"repo":"gseok/gseok.github.com"}}}}},"pageContext":{"slug":"/tech-talk-2020/2020-01-10-DOM-screenshot/","nextSlug":"/tech-talk-2019/2019-10-21-Jenkins-Abort/","prevSlug":"/tech-talk-2020/2020-02-06-Debug-breakpoint-ignored/"}},"staticQueryHashes":["1073350324","1956554647","2938748437"]}